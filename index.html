<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Bíblico por Bloques</title>
<style>
  body {
    background-color: #1e1a0f;
    color: #f3e5ab;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin: 20px 0 10px;
    font-weight: 700;
    color: #d4af37;
    text-shadow: 0 0 8px #d4af37;
  }
  #bloqueSelector, #startBtn, #quizContainer, #resultContainer {
    margin: 10px;
    width: 90vw;
    max-width: 600px;
    background: #3b361a;
    border-radius: 10px;
    box-shadow: 0 0 10px #d4af37aa;
    padding: 15px;
  }
  select, button {
    font-size: 1rem;
    padding: 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    box-shadow: 0 0 5px #d4af37aa;
    background-color: #d4af37;
    color: #1e1a0f;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  select:hover, button:hover {
    background-color: #b88b0b;
  }
  #quizContainer {
    display: none;
    flex-direction: column;
  }
  .cita-texto {
    font-size: 1.2rem;
    margin-bottom: 15px;
    font-style: italic;
  }
  .pregunta-block {
    margin-bottom: 20px;
  }
  .opciones-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
  }
  .opcion-btn {
    flex: 1 1 45%;
    background-color: #8c7d2d;
    border-radius: 8px;
    color: #f3e5ab;
    font-weight: 600;
    border: 2px solid transparent;
    transition: background-color 0.4s, border-color 0.4s;
    padding: 10px;
    cursor: pointer;
    user-select: none;
  }
  .opcion-btn.correct {
    background-color: #4caf50;
    border-color: #2e7d32;
    color: white;
  }
  .opcion-btn.incorrect {
    background-color: #e53935;
    border-color: #b71c1c;
    color: white;
  }
  .opcion-btn.disabled {
    pointer-events: none;
    opacity: 0.75;
  }
  #temporizadorBarra {
    height: 12px;
    width: 100%;
    background-color: #555;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 15px;
  }
  #barraProgreso {
    height: 100%;
    width: 100%;
    background-color: #4caf50;
    transition: width 1s linear, background-color 0.5s;
  }
  #contador {
    font-size: 1.1rem;
    font-weight: 700;
    text-align: right;
    margin-bottom: 10px;
  }
  #resultContainer {
    display: none;
    text-align: center;
  }
  #resultContainer p {
    font-size: 1.2rem;
    margin: 15px 0;
  }
  #resultContainer button {
    margin: 10px 5px;
    min-width: 130px;
  }
</style>
</head>
<body>

<h1>Quiz Bíblico por Bloques</h1>

<div id="bloqueSelector">
  <label for="selectBloque">Elige un bloque:</label>
  <select id="selectBloque">
    <option value="" disabled selected>Selecciona bloque</option>
  </select>
  <button id="startBtn" disabled>Iniciar Quiz</button>
</div>

<div id="quizContainer">
  <div id="temporizadorBarra">
    <div id="barraProgreso"></div>
  </div>
  <div id="contador">Tiempo: 15s</div>

  <div class="pregunta-block">
    <div class="cita-texto" id="textoCita"></div>
  </div>

  <div class="pregunta-block">
    <strong>Elige el libro correcto:</strong>
    <div class="opciones-group" id="opcionesLibro"></div>
  </div>

  <div class="pregunta-block">
    <strong>Elige el capítulo correcto:</strong>
    <div class="opciones-group" id="opcionesCapitulo"></div>
  </div>
</div>

<div id="resultContainer">
  <p id="mensajeResultado"></p>
  <p id="porcentajeResultado"></p>
  <button id="btnReiniciar">Reiniciar Quiz</button>
  <button id="btnVolverInicio">Volver a Inicio</button>
</div>

<script>
  // Sonidos
  const sonidoInicio = new Audio('start.mp3');
  const sonidoAdvertencia = new Audio('warning.mp3');
  const sonidoFin = new Audio('end.mp3');
  const sonidoCorrecto = new Audio('correct.mp3');
  const sonidoIncorrecto = new Audio('incorrect.mp3');

  // Elementos DOM
  const selectBloque = document.getElementById('selectBloque');
  const startBtn = document.getElementById('startBtn');
  const quizContainer = document.getElementById('quizContainer');
  const textoCita = document.getElementById('textoCita');
  const opcionesLibroDiv = document.getElementById('opcionesLibro');
  const opcionesCapituloDiv = document.getElementById('opcionesCapitulo');
  const barraProgreso = document.getElementById('barraProgreso');
  const contadorTexto = document.getElementById('contador');
  const resultContainer = document.getElementById('resultContainer');
  const mensajeResultado = document.getElementById('mensajeResultado');
  const porcentajeResultado = document.getElementById('porcentajeResultado');
  const btnReiniciar = document.getElementById('btnReiniciar');
  const btnVolverInicio = document.getElementById('btnVolverInicio');

  let citas = [];
  let bloqueActual = null;
  let preguntasBloque = [];
  let preguntaIndex = 0;
  let tiempoTotal = 15; // segundos por pregunta
  let tiempoRestante = tiempoTotal;
  let timerInterval = null;
  let aciertosLibro = 0;
  let aciertosCapitulo = 0;
  let preguntaRespondida = false;

  // Cargar JSON externo
  async function cargarCitas() {
    try {
      const response = await fetch('citas.json');
      if (!response.ok) throw new Error('Error al cargar citas.json');
      citas = await response.json();
      cargarBloques();
    } catch (error) {
      alert('No se pudo cargar las citas. Revisa que citas.json esté en el lugar correcto.');
      console.error(error);
    }
  }

  // Llenar selector de bloques disponibles
  function cargarBloques() {
    const bloquesUnicos = [...new Set(citas.map(cita => cita.bloque))];
    bloquesUnicos.sort((a,b) => a - b);
    bloquesUnicos.forEach(bloque => {
      const option = document.createElement('option');
      option.value = bloque;
      option.textContent = `Bloque ${bloque}`;
      selectBloque.appendChild(option);
    });
    startBtn.disabled = false;
  }

  // Iniciar quiz en bloque seleccionado
  startBtn.addEventListener('click', () => {
    bloqueActual = parseInt(selectBloque.value);
    preguntasBloque = citas.filter(cita => cita.bloque === bloqueActual);
    if(preguntasBloque.length === 0) {
      alert('No hay preguntas para este bloque.');
      return;
    }
    // Reiniciar variables
    preguntaIndex = 0;
    aciertosLibro = 0;
    aciertosCapitulo = 0;
    resultContainer.style.display = 'none';
    selectBloque.parentElement.style.display = 'none';
    quizContainer.style.display = 'flex';
    startBtn.disabled = true;
    mostrarPregunta();
    reproducirSonido(sonidoInicio);
  });

  // Mostrar pregunta actual
  function mostrarPregunta() {
    preguntaRespondida = false;
    tiempoRestante = tiempoTotal;
    const pregunta = preguntasBloque[preguntaIndex];
    textoCita.textContent = `"${pregunta.cita}"`;

    // Limpiar opciones anteriores
    opcionesLibroDiv.innerHTML = '';
    opcionesCapituloDiv.innerHTML = '';
    barraProgreso.style.width = '100%';
    barraProgreso.style.backgroundColor = '#4caf50';
    contadorTexto.textContent = `Tiempo: ${tiempoRestante}s`;

    // Crear botones opciones libro
    pregunta.opciones_libro.forEach((libro, i) => {
      const btn = document.createElement('button');
      btn.textContent = libro;
      btn.classList.add('opcion-btn');
      btn.addEventListener('click', () => seleccionarRespuesta('libro', libro, i));
      opcionesLibroDiv.appendChild(btn);
    });

    // Crear botones opciones capitulo
    pregunta.opciones_capitulo.forEach((cap, i) => {
      const btn = document.createElement('button');
      btn.textContent = cap;
      btn.classList.add('opcion-btn');
      btn.addEventListener('click', () => seleccionarRespuesta('capitulo', cap, i));
      opcionesCapituloDiv.appendChild(btn);
    });

    // Iniciar temporizador
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(actualizarTemporizador, 1000);
  }

  // Actualizar barra y contador cada segundo
  function actualizarTemporizador() {
    tiempoRestante--;
    const porcentaje = (tiempoRestante / tiempoTotal) * 100;
    barraProgreso.style.width = porcentaje + '%';

    if (porcentaje > 50) {
      barraProgreso.style.backgroundColor = '#4caf50'; // verde
    } else if (porcentaje > 20) {
      barraProgreso.style.backgroundColor = '#ffeb3b'; // amarillo
      if(tiempoRestante === 3) reproducirSonido(sonidoAdvertencia);
    } else {
      barraProgreso.style.backgroundColor = '#f44336'; // rojo
    }

    contadorTexto.textContent = `Tiempo: ${tiempoRestante}s`;

    if (tiempoRestante <= 0) {
      clearInterval(timerInterval);
      manejarTiempoAgotado();
    }
  }

  // Cuando el tiempo se agota sin respuesta
  function manejarTiempoAgotado() {
    if (!preguntaRespondida) {
      preguntaRespondida = true;
      reproducirSonido(sonidoFin);
      mostrarRespuestasCorrectas();
      setTimeout(siguientePregunta, 3000);
    }
  }

  // Manejar selección respuesta
  function seleccionarRespuesta(tipo, valor, indice) {
    if (preguntaRespondida) return;
    preguntaRespondida = true;
    clearInterval(timerInterval);

    const pregunta = preguntasBloque[preguntaIndex];

    // Determinar correcta según tipo
    let esCorrecto = false;
    if (tipo === 'libro') {
      esCorrecto = (valor === pregunta.libro);
      if (esCorrecto) aciertosLibro++;
    } else if (tipo === 'capitulo') {
      esCorrecto = (valor === pregunta.capitulo);
      if (esCorrecto) aciertosCapitulo++;
    }

    // Sonidos correctos o incorrectos
    if (esCorrecto) {
      reproducirSonido(sonidoCorrecto);
    } else {
      reproducirSonido(sonidoIncorrecto);
    }

    // Marcar botones con colores
    marcarOpciones(tipo, valor, pregunta);

    // Esperar 3 segundos y siguiente pregunta
    setTimeout(siguientePregunta, 3000);
  }

  // Marcar opciones como correctas o incorrectas visualmente
  function marcarOpciones(tipo, valorSeleccionado, pregunta) {
    let contenedor = tipo === 'libro' ? opcionesLibroDiv : opcionesCapituloDiv;
    const botones = contenedor.querySelectorAll('button');
    botones.forEach(btn => {
      btn.classList.add('disabled');
      if (tipo === 'libro') {
        if (btn.textContent === pregunta.libro) btn.classList.add('correct');
        else if (btn.textContent === valorSeleccionado) btn.classList.add('incorrect');
      } else {
        if (btn.textContent == pregunta.capitulo) btn.classList.add('correct');
        else if (btn.textContent == valorSeleccionado) btn.classList.add('incorrect');
      }
    });
  }

  // Mostrar respuestas correctas cuando se agota el tiempo
  function mostrarRespuestasCorrectas() {
    marcarOpciones('libro', null, preguntasBloque[preguntaIndex]);
    marcarOpciones('capitulo', null, preguntasBloque[preguntaIndex]);
  }

  // Pasar a siguiente pregunta o mostrar resultado final
  function siguientePregunta() {
    preguntaIndex++;
    if (preguntaIndex < preguntasBloque.length) {
      mostrarPregunta();
    } else {
      mostrarResultadoFinal();
    }
  }

  // Mostrar resultado final con mensajes personalizados
  function mostrarResultadoFinal() {
    quizContainer.style.display = 'none';
    resultContainer.style.display = 'block';

    let totalPreguntas = preguntasBloque.length;
    let porcentajeLibro = Math.round((aciertosLibro / totalPreguntas) * 100);
    let porcentajeCapitulo = Math.round((aciertosCapitulo / totalPreguntas) * 100);
    let promedio = Math.round((porcentajeLibro + porcentajeCapitulo) / 2);

    porcentajeResultado.textContent = `Aciertos: Libro ${porcentajeLibro}% - Capítulo ${porcentajeCapitulo}% (Promedio: ${promedio}%)`;

    // Mensaje según promedio
    let mensaje = '';
    if (promedio >= 90) mensaje = '¡Excelente conocimiento bíblico!';
    else if (promedio >= 70) mensaje = 'Buen trabajo, sigue estudiando.';
    else if (promedio >= 50) mensaje = 'Puedes mejorar, sigue practicando.';
    else mensaje = 'Te recomendamos dedicar más tiempo a la Biblia.';

    mensajeResultado.textContent = mensaje;
